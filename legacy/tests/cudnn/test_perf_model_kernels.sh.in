#!/bin/bash

BENCHMARK_ROOT=@CMAKE_CURRENT_BINARY_DIR@/../../../bin
TEST_UTIL=@CMAKE_CURRENT_BINARY_DIR@/../test_util.sh
TEST_CUDNN_UTIL=@CMAKE_CURRENT_BINARY_DIR@/test_cudnn_util.sh
DISTCONV_CONV_BENCHMARK=${BENCHMARK_ROOT}/distconv_benchmark
DISTCONV_POOL_BENCHMARK=${BENCHMARK_ROOT}/distconv_benchmark_pooling
DISTCONV_BN_BENCHMARK=${BENCHMARK_ROOT}/distconv_benchmark_bn
REFERENCE=. # N/A

# Main

. ${TEST_UTIL}
. ${TEST_CUDNN_UTIL}


function run_test_perf() {
    if [[ $1 = "conv" ]]; then
        bench=${DISTCONV_CONV_BENCHMARK}
        halo_exchange_method=HYBRID
    elif [[ $1 = "pool" ]]; then
        bench=${DISTCONV_POOL_BENCHMARK}
        halo_exchange_method=HYBRID
    elif [[ $1 = "bn" ]]; then
        bench=${DISTCONV_BN_BENCHMARK}
        halo_exchange_method=MPI
    elif [[ $1 = "deconv" ]]; then
        bench=${DISTCONV_CONV_BENCHMARK}
        halo_exchange_method=HYBRID
    else
        echo "Invalid layer type: $1" >&2
        exit
    fi

    expr_name=log_`echo $@ | sed "s/[ ,]/_/g"`
    mkdir ${expr_name}
    pushd .
    cd ${expr_name}
    run_test ${bench} ${REFERENCE} $@ SIMPLE $halo_exchange_method
    popd
}

# TYPE DATA_TYPE DIM N C K D,H,W F S PAD PN PS BIAS OVERLAP
# CosmoFlow

run_test_perf conv float 3 1 128 256 16,16,16 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 128 256 3,16,16 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 16 32 14,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 16 32 2,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 16 32 3,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 16 32 30,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 16 32 6,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 256 256 3,8,8 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 256 256 4,4,4 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 256 256 8,8,8 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 32 64 14,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 32 64 2,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 32 64 3,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 32 64 6,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 4 16 14,512,512 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 4 16 2,512,512 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 4 16 3,512,512 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 4 16 30,512,512 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 4 16 6,512,512 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 4 16 62,512,512 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 128 2,64,64 3 2 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 128 3,64,64 3 2 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 128 6,64,64 3 2 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 128 64,64,64 3 2 1 1 1,1,1 0 0

run_test_perf pool float 3 1 128 2,32,32 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 128 3,32,32 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 128 32,32,32 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 16 14,512,512 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 16 2,512,512 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 16 3,512,512 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 16 30,512,512 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 16 6,512,512 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 16 62,512,512 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 256 16,16,16 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 256 3,16,16 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 256 3,8,8 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 256 4,4,4 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 256 8,8,8 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 32 14,256,256 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 32 2,256,256 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 32 3,256,256 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 32 30,256,256 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 32 6,256,256 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 64 14,128,128 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 64 2,128,128 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 64 3,128,128 3 2 1 1 1,1,1 0 0
run_test_perf pool float 3 1 64 6,128,128 3 2 1 1 1,1,1 0 0

run_test_perf bn float 3 1 128 128 1,32,32 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 128 128 2,32,32 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 128 128 32,32,32 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 128 128 4,32,32 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 16 16 16,512,512 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 16 16 32,512,512 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 16 16 4,512,512 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 16 16 64,512,512 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 16 16 8,512,512 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 1,16,16 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 1,8,8 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 16,16,16 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 2,16,16 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 4,4,4 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 8,8,8 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 32 32 16,256,256 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 32 32 2,256,256 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 32 32 32,256,256 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 32 32 4,256,256 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 32 32 8,256,256 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 1,128,128 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 16,128,128 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 2,128,128 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 4,128,128 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 8,128,128 1 1 1 1 1,1,1 0 0

# U-Net

run_test_perf conv float 3 1 1 32 14,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 1 32 3,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 1 32 6,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 128 128 2,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 128 128 2,64,64 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 128 128 3,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 128 128 3,64,64 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 128 128 6,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 128 256 2,64,64 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 128 256 3,64,64 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 196 64 14,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 196 64 3,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 196 64 6,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 256 256 2,64,64 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 256 256 3,32,32 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 256 256 3,64,64 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 256 512 3,32,32 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 32 64 14,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 32 64 3,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 32 64 6,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 384 128 2,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 384 128 3,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 384 128 6,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 128 2,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 128 3,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 128 6,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 3 14,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 3 3,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 3 6,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 64 14,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 64 2,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 64 3,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 64 3,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 64 6,128,128 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 64 64 6,256,256 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 768 256 2,64,64 3 1 1 1 1,1,1 0 0
run_test_perf conv float 3 1 768 256 3,64,64 3 1 1 1 1,1,1 0 0

run_test_perf deconv float 3 1 128 128 4,128,128 2 2 0 1 1,1,1 0 0
run_test_perf deconv float 3 1 128 128 8,128,128 2 2 0 1 1,1,1 0 0
run_test_perf deconv float 3 1 256 256 2,64,64 2 2 0 1 1,1,1 0 0
run_test_perf deconv float 3 1 256 256 4,64,64 2 2 0 1 1,1,1 0 0
run_test_perf deconv float 3 1 512 512 1,32,32 2 2 0 1 1,1,1 0 0
run_test_perf deconv float 3 1 512 512 2,32,32 2 2 0 1 1,1,1 0 0

run_test_perf pool float 3 1 128 4,128,128 2 2 0 1 1,1,1 0 0
run_test_perf pool float 3 1 128 8,128,128 2 2 0 1 1,1,1 0 0
run_test_perf pool float 3 1 256 2,64,64 2 2 0 1 1,1,1 0 0
run_test_perf pool float 3 1 256 4,64,64 2 2 0 1 1,1,1 0 0
run_test_perf pool float 3 1 64 16,256,256 2 2 0 1 1,1,1 0 0
run_test_perf pool float 3 1 64 8,256,256 2 2 0 1 1,1,1 0 0

run_test_perf bn float 3 1 128 128 2,64,64 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 128 128 4,128,128 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 128 128 4,64,64 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 128 128 8,128,128 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 1,32,32 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 2,32,32 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 2,64,64 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 256 256 4,64,64 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 32 32 16,256,256 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 32 32 8,256,256 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 512 512 1,32,32 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 512 512 2,32,32 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 16,256,256 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 4,128,128 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 8,128,128 1 1 1 1 1,1,1 0 0
run_test_perf bn float 3 1 64 64 8,256,256 1 1 1 1 1,1,1 0 0

echo "Completed successfully"
